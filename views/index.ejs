<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css"
			rel="stylesheet"
		/>
		<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
		<link rel="stylesheet" href="estilos.css" />
		<title>Map App</title>
	</head>
	<body>
		<div id="map" style="width: 100%; height: 400px"></div>
		<% const tokenID = locals.tokenID %>
		<div class="markers">
			<div class="markersControls">
				<input
					type="text"
					placeholder="Nombre del Marcador"
					name="markerName"
					id="markerName"
				/>
				<input
					type="number"
					placeholder="Latitud"
					name="iLat"
					id="iLat"
				/>
				<input
					type="number"
					placeholder="Longitud"
					name="iLng"
					id="iLng"
				/>
				<button id="click" type="button">Get Map</button>
				<button id="btnMarker" type="button">Set Marker</button>
			</div>

			<table id="tableMarkers">
				<thead>
					<th>Markers</th>
					<th>Lat</th>
					<th>Lng</th>
				</thead>
				<tbody id="tBMarkers">
					<tr></tr>
				</tbody>
			</table>
		</div>
	</body>
</html>

<script>
	function getMap() {
		mapboxgl.accessToken = '<%- tokenID %>'
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			center: [-73.935242, 40.73061],
			zoom: 0,
		})
		return map
	}
	function setMarker(lng, lat, containerID) {
		try {
			const marker = new mapboxgl.Marker({
				draggable: true,
			})
				.setLngLat([lng, lat])
				.addTo(containerID)
			getMarkers(marker)
			return marker
		} catch (error) {
			console.error(error)
		}
	}

	document.getElementById('click').addEventListener('click', function () {
		getMap()
	})
	document.getElementById('btnMarker').addEventListener('click', function () {
		try {
			const lat = document.getElementById('iLat').value
			const lng = document.getElementById('iLng').value
			const marker = setMarker(lat, lng, map)

			marker.on('dragend', function (e) {
				console.log(marker.getLngLat())
			})
		} catch (error) {
			console.log(error)
		}
	})
	const map = getMap()
	function getMarkers(marker) {
		document
			.getElementById('tBMarkers')
			.querySelectorAll('tr')
			.forEach((tr) => {
				tr.remove()
			})
		markers.push({
			name: document.getElementById('markerName').value,
			lng: marker.getLngLat().lng,
			lat: marker.getLngLat().lat,
		})
		markers.forEach(function (marker) {
			const table = document.getElementById('tBMarkers')
			const row = document.createElement('tr')
			const name = document.createElement('td')
			const tdlng = document.createElement('td')
			const tdlat = document.createElement('td')

			name.innerHTML = marker.name
			tdlng.innerHTML = marker.lng
			tdlat.innerHTML = marker.lat
			row.append(name, tdlng, tdlat)
			table.appendChild(row)
		})

		document.querySelectorAll('inputs').forEach(function (input) {
			input.reset()
		})
	}
	let markers = []
</script>
